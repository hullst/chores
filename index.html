<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Hull Chores">
<title>Hull Family Chore Board</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root { --bg: #FFF9F0; --card-bg: #fff; --shadow: 0 4px 20px rgba(0,0,0,0.08); --radius: 20px; }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Nunito', sans-serif; background: var(--bg); min-height: 100vh; padding: 16px; }

  header { text-align: center; margin-bottom: 14px; }
  header h1 { font-family: 'Fredoka One', cursive; font-size: clamp(1.8rem,4vw,2.8rem); color: #2D2D2D; }
  header .subtitle { font-size: 0.95rem; color: #888; font-weight: 600; margin-top: 4px; }

  .top-bar {
    position: sticky; top: 0; z-index: 100;
    background: var(--bg); padding: 8px 0 10px;
    display: flex; align-items: center; justify-content: space-between;
    gap: 8px; flex-wrap: wrap; margin-bottom: 14px;
  }

  .jump-links { display: flex; gap: 6px; flex-wrap: wrap; }

  .jump-link {
    display: flex; align-items: center; gap: 5px;
    padding: 7px 13px; border-radius: 50px;
    text-decoration: none; font-weight: 800; font-size: 0.85rem;
    color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .jump-link:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

  .right-bar { display: flex; align-items: center; gap: 8px; }

  .day-badge {
    font-family: 'Fredoka One', cursive;
    font-size: 0.9rem; padding: 7px 14px;
    border-radius: 50px; color: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .day-badge.saturday { background: linear-gradient(135deg,#f7971e,#ffd200); color: #333; }
  .day-badge.sunday   { background: linear-gradient(135deg,#667eea,#764ba2); }

  .sync-indicator {
    display: flex; align-items: center; gap: 7px;
    font-size: 0.8rem; font-weight: 700; color: #aaa;
    background: white; padding: 7px 14px; border-radius: 50px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.07); white-space: nowrap;
  }
  .sync-indicator.syncing { color: #f7971e; }
  .sync-indicator.synced  { color: #43e97b; }
  .sync-indicator.error   { color: #f5576c; }
  .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
  .sync-dot.spinning { animation: pulse 0.8s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.8)} }

  .summary-bar { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin-bottom: 18px; }
  .summary-item {
    background: white; padding: 7px 16px; border-radius: 50px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.06); font-size: 0.88rem; font-weight: 700; color: #555;
  }

  .kids-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr));
    gap: 18px; max-width: 1400px; margin: 0 auto;
  }

  .kid-card {
    background: var(--card-bg); border-radius: var(--radius);
    box-shadow: var(--shadow); overflow: hidden; scroll-margin-top: 80px;
  }

  .kid-header {
    padding: 16px 20px 12px; display: flex; align-items: center;
    gap: 14px; position: relative;
  }
  .kid-avatar {
    width: 50px; height: 50px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem; flex-shrink: 0;
  }
  .kid-info h2 { font-family: 'Fredoka One', cursive; font-size: 1.3rem; color: #2D2D2D; }
  .kid-age { font-size: 0.72rem; font-weight: 700; color: #999; text-transform: uppercase; letter-spacing: 1px; }
  .progress-bar-wrap { height: 7px; background: #F0F0F0; border-radius: 4px; overflow: hidden; margin-top: 7px; }
  .progress-bar { height: 100%; border-radius: 4px; transition: width 0.4s ease; }
  .score-badge {
    position: absolute; top: 16px; right: 16px;
    font-family: 'Fredoka One', cursive; font-size: 1rem;
    padding: 4px 12px; border-radius: 50px; color: white;
  }

  .tod-divider { display: flex; align-items: center; gap: 8px; padding: 10px 14px 3px; }
  .tod-divider-label { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; white-space: nowrap; }
  .tod-divider-line  { flex: 1; height: 1.5px; border-radius: 1px; }
  .tod-morning   .tod-divider-label { color: #f7971e; }
  .tod-morning   .tod-divider-line  { background: #f7971e44; }
  .tod-afternoon .tod-divider-label { color: #38c172; }
  .tod-afternoon .tod-divider-line  { background: #38c17244; }
  .tod-evening   .tod-divider-label { color: #764ba2; }
  .tod-evening   .tod-divider-line  { background: #764ba244; }

  .chore-list { padding: 0 14px 14px; }
  .chore-item {
    display: flex; align-items: center; gap: 12px;
    padding: 9px 10px; border-radius: 12px; margin-bottom: 3px;
    cursor: pointer; transition: background 0.15s; user-select: none;
  }
  .chore-item:hover  { background: #F8F8F8; }
  .chore-item:active { background: #F0F0F0; }
  .chore-item.done   { opacity: 0.45; }
  .chore-check {
    width: 24px; height: 24px; border-radius: 50%;
    border: 2.5px solid #DDD;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all 0.2s; font-size: 0.85rem; color: white;
  }
  .chore-item.done .chore-check { border-color: transparent; }
  .chore-item.done .chore-label { text-decoration: line-through; color: #AAA; }
  .chore-label { font-size: 0.88rem; font-weight: 700; color: #333; flex: 1; }
  .chore-time  { font-size: 0.65rem; color: #bbb; font-weight: 600; }
  .chore-icon  { font-size: 1rem; }

  .reset-btn {
    display: block; margin: 24px auto 32px;
    padding: 10px 28px; border-radius: 50px;
    border: 2px solid #DDD; background: white;
    font-family: 'Nunito', sans-serif; font-weight: 700;
    font-size: 0.9rem; cursor: pointer; color: #777; transition: all 0.2s;
  }
  .reset-btn:hover { border-color: #aaa; color: #333; }

  .confetti-pop { animation: pop 0.25s ease; }
  @keyframes pop { 0%{transform:scale(1)} 50%{transform:scale(1.12)} 100%{transform:scale(1)} }

  /* Kid color themes */
  .kid-theodore .kid-header { background: linear-gradient(135deg,#667eea22,#764ba222); }
  .kid-theodore .kid-avatar { background: linear-gradient(135deg,#667eea,#764ba2); }
  .kid-theodore .progress-bar { background: linear-gradient(90deg,#667eea,#764ba2); }
  .kid-theodore .score-badge { background: linear-gradient(135deg,#667eea,#764ba2); }
  .kid-theodore .chore-item.done .chore-check { background: linear-gradient(135deg,#667eea,#764ba2); }
  .jump-theodore { background: linear-gradient(135deg,#667eea,#764ba2); }

  .kid-alice .kid-header { background: linear-gradient(135deg,#f093fb22,#f5576c22); }
  .kid-alice .kid-avatar { background: linear-gradient(135deg,#f093fb,#f5576c); }
  .kid-alice .progress-bar { background: linear-gradient(90deg,#f093fb,#f5576c); }
  .kid-alice .score-badge { background: linear-gradient(135deg,#f093fb,#f5576c); }
  .kid-alice .chore-item.done .chore-check { background: linear-gradient(135deg,#f093fb,#f5576c); }
  .jump-alice { background: linear-gradient(135deg,#f093fb,#f5576c); }

  .kid-andrew .kid-header { background: linear-gradient(135deg,#4facfe22,#00f2fe22); }
  .kid-andrew .kid-avatar { background: linear-gradient(135deg,#4facfe,#00f2fe); }
  .kid-andrew .progress-bar { background: linear-gradient(90deg,#4facfe,#00f2fe); }
  .kid-andrew .score-badge { background: linear-gradient(135deg,#4facfe,#00f2fe); }
  .kid-andrew .chore-item.done .chore-check { background: linear-gradient(135deg,#4facfe,#00f2fe); }
  .jump-andrew { background: linear-gradient(135deg,#4facfe,#00f2fe); }

  .kid-felix .kid-header { background: linear-gradient(135deg,#43e97b22,#38f9d722); }
  .kid-felix .kid-avatar { background: linear-gradient(135deg,#43e97b,#38f9d7); }
  .kid-felix .progress-bar { background: linear-gradient(90deg,#43e97b,#38f9d7); }
  .kid-felix .score-badge { background: linear-gradient(135deg,#43e97b,#38f9d7); }
  .kid-felix .chore-item.done .chore-check { background: linear-gradient(135deg,#43e97b,#38f9d7); }
  .jump-felix { background: linear-gradient(135deg,#43e97b,#38f9d7); }

  .kid-lucy .kid-header { background: linear-gradient(135deg,#fa709a22,#fee14022); }
  .kid-lucy .kid-avatar { background: linear-gradient(135deg,#fa709a,#fee140); }
  .kid-lucy .progress-bar { background: linear-gradient(90deg,#fa709a,#fee140); }
  .kid-lucy .score-badge { background: linear-gradient(135deg,#fa709a,#fee140); }
  .kid-lucy .chore-item.done .chore-check { background: linear-gradient(135deg,#fa709a,#fee140); }
  .jump-lucy { background: linear-gradient(135deg,#fa709a,#fee140); }

  .kid-leo .kid-header { background: linear-gradient(135deg,#f7971e22,#ffd20022); }
  .kid-leo .kid-avatar { background: linear-gradient(135deg,#f7971e,#ffd200); }
  .kid-leo .progress-bar { background: linear-gradient(90deg,#f7971e,#ffd200); }
  .kid-leo .score-badge { background: linear-gradient(135deg,#f7971e,#ffd200); }
  .kid-leo .chore-item.done .chore-check { background: linear-gradient(135deg,#f7971e,#ffd200); }
  .jump-leo { background: linear-gradient(135deg,#f7971e,#ffd200); }
</style>
</head>
<body>

<header>
  <h1>‚≠ê Hull Family Chores</h1>
  <p class="subtitle" id="headerSubtitle"></p>
</header>

<div class="top-bar">
  <div class="jump-links" id="jumpLinks"></div>
  <div class="right-bar">
    <div class="day-badge" id="dayBadge"></div>
    <div class="sync-indicator synced" id="syncIndicator">
      <div class="sync-dot" id="syncDot"></div>
      <span id="syncLabel">Live</span>
    </div>
  </div>
</div>

<div class="summary-bar" id="summaryBar"></div>
<div class="kids-grid" id="kidsGrid"></div>
<button class="reset-btn" onclick="resetAll()">üîÑ Reset All Chores</button>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey: "AIzaSyBImvAIHP_3S9aDl0_yjhwtGG5pf1e5Z7k",
  authDomain: "hull-chores.firebaseapp.com",
  projectId: "hull-chores"
});
var db = firebase.firestore();

// =============================================
// KIDS
// =============================================
var KIDS = [
  { id:'theodore', name:'Theodore', age:11, emoji:'ü¶Å' },
  { id:'alice',    name:'Alice',    age:9,  emoji:'ü¶ã' },
  { id:'andrew',   name:'Andrew',   age:8,  emoji:'üöÄ' },
  { id:'felix',    name:'Felix',    age:6,  emoji:'üê∏' },
  { id:'lucy',     name:'Lucy',     age:5,  emoji:'üå∏' },
  { id:'leo',      name:'Leo',      age:3,  emoji:'üêª' },
];

var BIG_KIDS = ['theodore','alice','andrew','felix'];

var TOD_ORDER  = ['morning','afternoon','evening'];
var TOD_LABELS = { morning:'üåÖ Morning', afternoon:'‚òÄÔ∏è Afternoon', evening:'üåÜ Evening' };

// =============================================
// ROTATION
// Day 0 = Sat Feb 28 2025 (existing saturday, no rotation)
// Day 1 = Sun Mar 1 2025 ‚Äî first rotation day
//
// Morning rotation (big kids): vacuum living room, vacuum front room, sophie, empty dishwasher
// Sunday Day 1 start: theodore=vacuum living room, alice=vacuum front room, andrew=sophie, felix=empty dishwasher
//
// Evening rotation (big kids): wipe counter, wipe table, tineco floor, take out trash
// Sunday Day 1 start: theodore=wipe counter, alice=wipe table, andrew=tineco, felix=trash
// =============================================

var ROTATION_EPOCH = new Date('2025-03-01T00:00:00'); // Day 1

var MORNING_ROTATION = [
  { label:'Vacuum living room',            icon:'üßπ' },
  { label:'Vacuum front room',             icon:'üßπ' },
  { label:"Fill up Sophie's food & water", icon:'üêæ' },
  { label:'Empty dishwasher',              icon:'üçΩÔ∏è' },
];

var EVENING_ROTATION = [
  { label:'Wipe kitchen counter', icon:'üßΩ' },
  { label:'Wipe kitchen table',   icon:'üßπ' },
  { label:'Tineco kitchen floor', icon:'ü§ñ' },
  { label:'Take out trash',       icon:'üóëÔ∏è' },
];

// Returns 0-based rotation index for a given date (days since epoch mod 4)
function getRotationIndex(dateObj) {
  var msPerDay = 24 * 60 * 60 * 1000;
  var diff = Math.floor((dateObj - ROTATION_EPOCH) / msPerDay);
  if (diff < 0) diff = 0;
  return diff % 4;
}

// For a big kid at BIG_KIDS index i, their chore on a given rotation index
// kid 0 (theodore) gets rotation[rotIdx], kid 1 gets rotation[(rotIdx+1)%4], etc.
function getRotatedChore(bigKidIndex, rotIdx, rotationArr) {
  return rotationArr[(rotIdx + bigKidIndex) % 4];
}

// =============================================
// CHORE BUILDERS
// =============================================

function buildSaturdayChores(kidId) {
  var chores = [];

  // Morning - everyone
  var morningAll = [
    { label:'Make bed',                    icon:'üõèÔ∏è', section:'Everyone' },
    { label:'Brush teeth',                 icon:'ü™•', section:'Everyone' },
    { label:'Get dressed',                 icon:'üëï', section:'Everyone' },
    { label:'Eat breakfast',               icon:'ü•£', section:'Everyone' },
    { label:'Bring plates to sink',        icon:'ü´ß', section:'Everyone' },
  ];
  for (var i = 0; i < morningAll.length; i++) {
    chores.push({ tod:'morning', section:morningAll[i].section, label:morningAll[i].label, icon:morningAll[i].icon });
  }

  // Morning - family specific (saturday fixed assignments)
  if (kidId === 'theodore') {
    chores.push({ tod:'morning', section:'Family Chores', label:'Unload dishwasher',  icon:'üçΩÔ∏è' });
    chores.push({ tod:'morning', section:'Family Chores', label:'Wipe bathroom sink',  icon:'üöø' });
  }
  if (kidId === 'alice' || kidId === 'lucy') {
    chores.push({ tod:'morning', section:'Family Chores', label:'Wipe bathroom sink',  icon:'üöø' });
  }
  if (kidId === 'andrew' || kidId === 'felix') {
    chores.push({ tod:'morning', section:'Family Chores', label:'Wipe bathroom sink',  icon:'üöø' });
  }
  if (kidId === 'leo') {
    chores.push({ tod:'morning', section:'Family Chores', label:'Wipe bathroom sink',  icon:'üöø' });
  }
  if (kidId === 'alice')  chores.push({ tod:'morning', section:'Family Chores', label:'Vacuum living room',           icon:'üßπ' });
  if (kidId === 'andrew') chores.push({ tod:'morning', section:'Family Chores', label:'Vacuum front room',            icon:'üßπ' });
  if (kidId === 'lucy' || kidId === 'leo') chores.push({ tod:'morning', section:'Family Chores', label:'Put away blankets', icon:'üõãÔ∏è' });
  if (kidId === 'felix')  chores.push({ tod:'morning', section:'Family Chores', label:"Fill up Sophie's food & water", icon:'üêæ' });

  // Kiss Momma - everyone
  chores.push({ tod:'morning', section:'‚ù§Ô∏è Special', label:'Go kiss Momma good morning!', icon:'üíã' });

  // Afternoon - everyone
  chores.push({ tod:'afternoon', section:'Everyone', label:'Eat lunch',                  icon:'ü•™' });
  chores.push({ tod:'afternoon', section:'Everyone', label:'Bring lunch plates to sink',  icon:'ü´ß' });
  chores.push({ tod:'afternoon', section:'Everyone', label:'Help fold laundry',           icon:'üëï' });
  chores.push({ tod:'afternoon', section:'Everyone', label:'Put away lunch stuff',        icon:'üßπ' });
  if (kidId === 'andrew') {
    chores.push({ tod:'afternoon', section:'Clean Up', label:'Load dishwasher',           icon:'ü´ß' });
    chores.push({ tod:'afternoon', section:'Clean Up', label:'Take out recyclables',      icon:'‚ôªÔ∏è' });
  }
  if (kidId === 'theodore') chores.push({ tod:'afternoon', section:'Bathrooms', label:'Clean pool bathroom',     icon:'üöø' });
  if (kidId === 'alice')    chores.push({ tod:'afternoon', section:'Bathrooms', label:'Clean front bathroom',    icon:'üöø' });
  if (kidId === 'felix')    chores.push({ tod:'afternoon', section:'Bathrooms', label:'Clean basement bathroom', icon:'üöø' });

  // Evening - everyone
  chores.push({ tod:'evening', section:'Everyone', label:'Eat dinner',                  icon:'üçΩÔ∏è' });
  chores.push({ tod:'evening', section:'Everyone', label:'Bring dinner plates to sink', icon:'ü´ß' });
  chores.push({ tod:'evening', section:'Everyone', label:'Eat dessert',                 icon:'üç®' });
  if (kidId === 'theodore') chores.push({ tod:'evening', section:'Clean Up', label:'Take out trash',        icon:'üóëÔ∏è' });
  if (kidId === 'alice')    chores.push({ tod:'evening', section:'Clean Up', label:'Wipe kitchen counter',  icon:'üßΩ' });
  if (kidId === 'andrew')   chores.push({ tod:'evening', section:'Clean Up', label:'Take out recyclables',  icon:'‚ôªÔ∏è' });
  if (kidId === 'felix')    chores.push({ tod:'evening', section:'Clean Up', label:'Load dishwasher',       icon:'üçΩÔ∏è' });
  if (kidId === 'lucy')     chores.push({ tod:'evening', section:'Clean Up', label:'Wipe kitchen table',    icon:'üßπ' });

  return chores;
}

function buildSundayChores(kidId, dateObj) {
  var chores = [];
  var rotIdx = getRotationIndex(dateObj);
  var bigIdx = BIG_KIDS.indexOf(kidId);

  // Morning - everyone
  var morningAll = [
    { label:'Make bed',          icon:'üõèÔ∏è', section:'Everyone' },
    { label:'Brush teeth',       icon:'ü™•', section:'Everyone' },
    { label:'Get dressed for church', icon:'‚õ™', section:'Everyone' },
    { label:'Eat breakfast',     icon:'ü•£', section:'Everyone' },
    { label:'Bring plates to sink', icon:'ü´ß', section:'Everyone' },
  ];
  for (var i = 0; i < morningAll.length; i++) {
    chores.push({ tod:'morning', section:morningAll[i].section, label:morningAll[i].label, icon:morningAll[i].icon });
  }

  // Morning rotation for big kids
  if (bigIdx !== -1) {
    var mc = getRotatedChore(bigIdx, rotIdx, MORNING_ROTATION);
    chores.push({ tod:'morning', section:'Family Chores', label:mc.label, icon:mc.icon });
  }

  // Lucy & Leo put away blankets
  if (kidId === 'lucy' || kidId === 'leo') {
    chores.push({ tod:'morning', section:'Family Chores', label:'Put away blankets', icon:'üõãÔ∏è' });
  }

  // Kiss Momma
  chores.push({ tod:'morning', section:'‚ù§Ô∏è Special', label:'Go kiss Momma good morning!', icon:'üíã' });

  // Afternoon - everyone
  chores.push({ tod:'afternoon', section:'Everyone', label:'Eat lunch',                 icon:'ü•™' });
  chores.push({ tod:'afternoon', section:'Everyone', label:'Bring lunch plates to sink', icon:'ü´ß' });
  chores.push({ tod:'afternoon', section:'Everyone', label:'Put away lunch stuff',       icon:'üßπ' });

  // Evening - everyone
  chores.push({ tod:'evening', section:'Everyone', label:'Eat dinner',                  icon:'üçΩÔ∏è' });
  chores.push({ tod:'evening', section:'Everyone', label:'Bring dinner plates to sink', icon:'ü´ß' });
  chores.push({ tod:'evening', section:'Everyone', label:'Eat dessert',                 icon:'üç®' });

  // Evening rotation for big kids
  if (bigIdx !== -1) {
    var ec = getRotatedChore(bigIdx, rotIdx, EVENING_ROTATION);
    chores.push({ tod:'evening', section:'Clean Up', label:ec.label, icon:ec.icon });
  }

  return chores;
}

// =============================================
// DAY DETECTION
// =============================================
function getTodayKey() {
  var d = new Date();
  var day = d.getDay(); // 0=Sun, 6=Sat
  if (day === 6) return 'saturday';
  if (day === 0) return 'sunday_' + getDateString(d);
  // Default to today's date key for any other day (extensible later)
  return 'sunday_' + getDateString(d);
}

function getDateString(d) {
  return d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate();
}

function isWeekend() {
  var day = new Date().getDay();
  return day === 6 || day === 0;
}

function isSunday() {
  return new Date().getDay() === 0;
}

function getChoresToday(kidId) {
  if (isSunday()) {
    return buildSundayChores(kidId, new Date());
  }
  return buildSaturdayChores(kidId);
}

// =============================================
// FIREBASE
// =============================================
var choreState = {};
var unsub = null;
var TODAY_KEY = getTodayKey();

function docRef() { return db.collection('chores').doc(TODAY_KEY); }

function subscribe() {
  if (unsub) unsub();
  setSyncStatus('syncing');
  unsub = docRef().onSnapshot(function(snap) {
    choreState = snap.exists ? (snap.data().state || {}) : {};
    setSyncStatus('synced');
    render();
  }, function() { setSyncStatus('error'); });
}

function save() {
  setSyncStatus('syncing');
  docRef().set({ state: choreState, updatedAt: Date.now() })
    .then(function() { setSyncStatus('synced'); })
    .catch(function() { setSyncStatus('error'); });
}

function setSyncStatus(s) {
  document.getElementById('syncIndicator').className = 'sync-indicator ' + s;
  document.getElementById('syncDot').className = 'sync-dot' + (s === 'syncing' ? ' spinning' : '');
  document.getElementById('syncLabel').textContent = s === 'syncing' ? 'Syncing...' : s === 'synced' ? 'Live' : 'Error';
}

// =============================================
// TOGGLE
// =============================================
function choreKey(kidId, tod, label) { return kidId + '__' + tod + '__' + label; }

function isChecked(kidId, tod, label) {
  var k = choreKey(kidId, tod, label);
  return !!(choreState[kidId] && choreState[kidId][k] && choreState[kidId][k].done);
}

function handleChore(kidId, tod, label, el) {
  el.classList.add('confetti-pop');
  setTimeout(function() { el.classList.remove('confetti-pop'); }, 250);
  var k = choreKey(kidId, tod, label);
  if (!choreState[kidId]) choreState[kidId] = {};
  var was = choreState[kidId][k] && choreState[kidId][k].done;
  choreState[kidId][k] = { done: !was, ts: Date.now() };
  render();
  save();
}

// =============================================
// RENDER
// =============================================
function render() {
  var sunday = isSunday();
  var dayName = sunday ? 'Sunday' : 'Saturday';
  var dayEmoji = sunday ? '‚õ™' : 'üóìÔ∏è';

  document.getElementById('headerSubtitle').textContent = dayEmoji + ' ' + dayName + ' Chores';
  var badge = document.getElementById('dayBadge');
  badge.textContent = dayName;
  badge.className = 'day-badge ' + (sunday ? 'sunday' : 'saturday');

  // Jump links
  document.getElementById('jumpLinks').innerHTML = KIDS.map(function(kid) {
    return '<a class="jump-link jump-' + kid.id + '" href="#card-' + kid.id + '">' +
      kid.emoji + ' ' + kid.name.split(' ')[0] + '</a>';
  }).join('');

  // Summary
  var totalDone = 0, totalAll = 0;
  for (var ki = 0; ki < KIDS.length; ki++) {
    var kc = getChoresToday(KIDS[ki].id);
    totalAll += kc.length;
    for (var ci = 0; ci < kc.length; ci++) {
      if (isChecked(KIDS[ki].id, kc[ci].tod, kc[ci].label)) totalDone++;
    }
  }
  var pct = totalAll ? Math.round(totalDone / totalAll * 100) : 0;
  document.getElementById('summaryBar').innerHTML =
    '<div class="summary-item">üìã ' + totalDone + ' / ' + totalAll + ' done</div>' +
    '<div class="summary-item">üèÜ ' + pct + '%</div>';

  // Kid cards
  var gridHtml = '';
  for (var k = 0; k < KIDS.length; k++) {
    var kid    = KIDS[k];
    var chores = getChoresToday(kid.id);
    var doneCt = 0;
    for (var c = 0; c < chores.length; c++) {
      if (isChecked(kid.id, chores[c].tod, chores[c].label)) doneCt++;
    }
    var kpct    = chores.length ? Math.round(doneCt / chores.length * 100) : 0;
    var allDone = chores.length > 0 && doneCt === chores.length;

    var choreHtml = '<div class="chore-list">';
    for (var ti = 0; ti < TOD_ORDER.length; ti++) {
      var tod = TOD_ORDER[ti];
      var todChores = chores.filter(function(ch) { return ch.tod === tod; });
      if (todChores.length === 0) continue;

      choreHtml += '<div class="tod-divider tod-' + tod + '">' +
        '<span class="tod-divider-label">' + TOD_LABELS[tod] + '</span>' +
        '<div class="tod-divider-line"></div></div>';

      for (var ii = 0; ii < todChores.length; ii++) {
        var ch     = todChores[ii];
        var isDone = isChecked(kid.id, tod, ch.label);
        var ck     = choreKey(kid.id, tod, ch.label);
        var ts     = choreState[kid.id] && choreState[kid.id][ck] && choreState[kid.id][ck].ts;
        var tStr   = ts ? new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
        var safe   = ch.label.replace(/\\/g,'\\\\').replace(/'/g,"\\'");

        choreHtml +=
          '<div class="chore-item' + (isDone ? ' done' : '') + '"' +
          ' onclick="handleChore(\'' + kid.id + '\',\'' + tod + '\',\'' + safe + '\',this)">' +
          '<div class="chore-check">' + (isDone ? '‚úì' : '') + '</div>' +
          '<span class="chore-icon">' + ch.icon + '</span>' +
          '<div style="flex:1"><div class="chore-label">' + ch.label + '</div>' +
          (isDone && tStr ? '<div class="chore-time">‚úì ' + tStr + '</div>' : '') +
          '</div></div>';
      }
    }
    choreHtml += '</div>';

    gridHtml +=
      '<div class="kid-card kid-' + kid.id + '" id="card-' + kid.id + '">' +
        '<div class="kid-header">' +
          '<div class="kid-avatar">' + kid.emoji + '</div>' +
          '<div class="kid-info" style="flex:1">' +
            '<h2>' + kid.name + (allDone ? ' üéâ' : '') + '</h2>' +
            '<div class="kid-age">Age ' + kid.age + '</div>' +
            '<div class="progress-bar-wrap"><div class="progress-bar" style="width:' + kpct + '%"></div></div>' +
          '</div>' +
          '<div class="score-badge">' + doneCt + '/' + chores.length + '</div>' +
        '</div>' +
        choreHtml +
      '</div>';
  }
  document.getElementById('kidsGrid').innerHTML = gridHtml;
}

function resetAll() {
  if (!confirm('Reset all chores for today?')) return;
  choreState = {};
  save();
  render();
}

// Boot
subscribe();
</script>
</body>
</html>
