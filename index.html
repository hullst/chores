<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Hull Chores">
<title>Hull Family Chore Board</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root { --bg: #FFF9F0; --card-bg: #fff; --shadow: 0 4px 20px rgba(0,0,0,0.08); --radius: 20px; }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Nunito', sans-serif; background: var(--bg); min-height: 100vh; padding: 16px; }

  header { text-align: center; margin-bottom: 14px; }
  header h1 { font-family: 'Fredoka One', cursive; font-size: clamp(1.8rem,4vw,2.8rem); color: #2D2D2D; }
  header .subtitle { font-size: 0.95rem; color: #888; font-weight: 600; margin-top: 4px; }

  .top-bar {
    position: sticky; top: 0; z-index: 100;
    background: var(--bg); padding: 8px 0 10px;
    display: flex; align-items: center; justify-content: space-between;
    gap: 8px; flex-wrap: wrap; margin-bottom: 14px;
  }
  .jump-links { display: flex; gap: 6px; flex-wrap: wrap; }
  .jump-link {
    display: flex; align-items: center; gap: 5px;
    padding: 7px 13px; border-radius: 50px;
    text-decoration: none; font-weight: 800; font-size: 0.85rem;
    color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .jump-link:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
  .right-bar { display: flex; align-items: center; gap: 8px; }
  .day-badge {
    font-family: 'Fredoka One', cursive; font-size: 0.9rem; padding: 7px 14px;
    border-radius: 50px; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .day-badge.saturday { background: linear-gradient(135deg,#f7971e,#ffd200); color: #333; }
  .day-badge.sunday   { background: linear-gradient(135deg,#667eea,#764ba2); }
  .sync-indicator {
    display: flex; align-items: center; gap: 7px; font-size: 0.8rem; font-weight: 700;
    color: #aaa; background: white; padding: 7px 14px; border-radius: 50px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.07); white-space: nowrap;
  }
  .sync-indicator.syncing { color: #f7971e; }
  .sync-indicator.synced  { color: #43e97b; }
  .sync-indicator.error   { color: #f5576c; }
  .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
  .sync-dot.spinning { animation: pulse 0.8s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.4;transform:scale(0.8)} }

  .summary-bar { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin-bottom: 18px; }
  .summary-item {
    background: white; padding: 7px 16px; border-radius: 50px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.06); font-size: 0.88rem; font-weight: 700; color: #555;
  }

  .kids-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr)); gap: 18px; max-width: 1400px; margin: 0 auto; }

  .kid-card { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; scroll-margin-top: 80px; }

  .kid-header { padding: 16px 20px 12px; display: flex; align-items: center; gap: 14px; position: relative; }

  /* Avatar - tappable */
  .kid-avatar {
    width: 54px; height: 54px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.6rem; flex-shrink: 0; cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
    position: relative;
  }
  .kid-avatar:hover { transform: scale(1.1); box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
  .kid-avatar:active { transform: scale(0.95); }
  .avatar-edit-hint {
    position: absolute; bottom: -2px; right: -2px;
    background: white; border-radius: 50%; width: 18px; height: 18px;
    font-size: 10px; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }

  .kid-info h2 { font-family: 'Fredoka One', cursive; font-size: 1.3rem; color: #2D2D2D; }
  .kid-age { font-size: 0.72rem; font-weight: 700; color: #999; text-transform: uppercase; letter-spacing: 1px; }
  .progress-bar-wrap { height: 7px; background: #F0F0F0; border-radius: 4px; overflow: hidden; margin-top: 7px; }
  .progress-bar { height: 100%; border-radius: 4px; transition: width 0.4s ease; }
  .score-badge {
    position: absolute; top: 16px; right: 16px; font-family: 'Fredoka One', cursive;
    font-size: 1rem; padding: 4px 12px; border-radius: 50px; color: white;
  }

  .tod-divider { display: flex; align-items: center; gap: 8px; padding: 10px 14px 3px; }
  .tod-divider-label { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; white-space: nowrap; }
  .tod-divider-line  { flex: 1; height: 1.5px; border-radius: 1px; }
  .tod-morning   .tod-divider-label { color: #f7971e; }
  .tod-morning   .tod-divider-line  { background: #f7971e44; }
  .tod-afternoon .tod-divider-label { color: #38c172; }
  .tod-afternoon .tod-divider-line  { background: #38c17244; }
  .tod-evening   .tod-divider-label { color: #764ba2; }
  .tod-evening   .tod-divider-line  { background: #764ba244; }

  .chore-list { padding: 0 14px 14px; }
  .chore-item {
    display: flex; align-items: center; gap: 12px;
    padding: 9px 10px; border-radius: 12px; margin-bottom: 3px;
    cursor: pointer; transition: background 0.15s; user-select: none;
  }
  .chore-item:hover  { background: #F8F8F8; }
  .chore-item:active { background: #F0F0F0; }
  .chore-item.done   { opacity: 0.45; }
  .chore-check {
    width: 24px; height: 24px; border-radius: 50%; border: 2.5px solid #DDD;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all 0.2s; font-size: 0.85rem; color: white;
  }
  .chore-item.done .chore-check { border-color: transparent; }
  .chore-item.done .chore-label { text-decoration: line-through; color: #AAA; }
  .chore-label { font-size: 0.88rem; font-weight: 700; color: #333; flex: 1; }
  .chore-time  { font-size: 0.65rem; color: #bbb; font-weight: 600; }
  .chore-icon  { font-size: 1rem; }

  /* Section complete flash */
  .tod-complete-flash { animation: sectionFlash 0.5s ease; }
  @keyframes sectionFlash { 0%{background:#fff} 40%{background:#d4f5d4} 100%{background:#fff} }

  .reset-btn {
    display: block; margin: 24px auto 32px; padding: 10px 28px; border-radius: 50px;
    border: 2px solid #DDD; background: white; font-family: 'Nunito', sans-serif;
    font-weight: 700; font-size: 0.9rem; cursor: pointer; color: #777; transition: all 0.2s;
  }
  .reset-btn:hover { border-color: #aaa; color: #333; }

  .confetti-pop { animation: pop 0.25s ease; }
  @keyframes pop { 0%{transform:scale(1)} 50%{transform:scale(1.12)} 100%{transform:scale(1)} }

  /* ---- AVATAR PICKER MODAL ---- */
  .modal-overlay {
    display: none; position: fixed; inset: 0; z-index: 999;
    background: rgba(0,0,0,0.5); align-items: center; justify-content: center;
    backdrop-filter: blur(4px);
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: white; border-radius: 24px; padding: 24px;
    max-width: 380px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: modalIn 0.2s ease;
  }
  @keyframes modalIn { from{transform:scale(0.85);opacity:0} to{transform:scale(1);opacity:1} }
  .modal h3 { font-family: 'Fredoka One', cursive; font-size: 1.4rem; color: #2D2D2D; margin-bottom: 16px; text-align: center; }
  .emoji-grid {
    display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px;
    max-height: 280px; overflow-y: auto; margin-bottom: 16px;
  }
  .emoji-opt {
    font-size: 1.6rem; padding: 6px; border-radius: 12px; cursor: pointer;
    text-align: center; transition: background 0.1s, transform 0.1s; border: 2.5px solid transparent;
  }
  .emoji-opt:hover  { background: #F0F0F0; transform: scale(1.15); }
  .emoji-opt.picked { border-color: #667eea; background: #667eea18; }
  .modal-close {
    display: block; width: 100%; padding: 10px; border-radius: 50px;
    border: 2px solid #EEE; background: white; font-family: 'Nunito', sans-serif;
    font-weight: 700; font-size: 0.95rem; cursor: pointer; color: #888; transition: all 0.15s;
  }
  .modal-close:hover { border-color: #ccc; color: #555; }

  /* ---- CELEBRATION OVERLAY ---- */
  .celebration {
    display: none; position: fixed; inset: 0; z-index: 998;
    align-items: center; justify-content: center; pointer-events: none;
  }
  .celebration.show { display: flex; }
  .celebration-inner {
    text-align: center; animation: celebIn 0.4s ease;
  }
  @keyframes celebIn { from{transform:scale(0.5);opacity:0} to{transform:scale(1);opacity:1} }
  .celebration-emoji { font-size: 5rem; display: block; }
  .celebration-text  { font-family: 'Fredoka One', cursive; font-size: 2rem; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.4); }

  .confetti-canvas { position: fixed; inset: 0; z-index: 997; pointer-events: none; }

  /* Kid color themes */
  .kid-theodore .kid-header { background: linear-gradient(135deg,#667eea22,#764ba222); }
  .kid-theodore .kid-avatar { background: linear-gradient(135deg,#667eea,#764ba2); }
  .kid-theodore .progress-bar { background: linear-gradient(90deg,#667eea,#764ba2); }
  .kid-theodore .score-badge { background: linear-gradient(135deg,#667eea,#764ba2); }
  .kid-theodore .chore-item.done .chore-check { background: linear-gradient(135deg,#667eea,#764ba2); }
  .jump-theodore { background: linear-gradient(135deg,#667eea,#764ba2); }

  .kid-alice .kid-header { background: linear-gradient(135deg,#f093fb22,#f5576c22); }
  .kid-alice .kid-avatar { background: linear-gradient(135deg,#f093fb,#f5576c); }
  .kid-alice .progress-bar { background: linear-gradient(90deg,#f093fb,#f5576c); }
  .kid-alice .score-badge { background: linear-gradient(135deg,#f093fb,#f5576c); }
  .kid-alice .chore-item.done .chore-check { background: linear-gradient(135deg,#f093fb,#f5576c); }
  .jump-alice { background: linear-gradient(135deg,#f093fb,#f5576c); }

  .kid-andrew .kid-header { background: linear-gradient(135deg,#4facfe22,#00f2fe22); }
  .kid-andrew .kid-avatar { background: linear-gradient(135deg,#4facfe,#00f2fe); }
  .kid-andrew .progress-bar { background: linear-gradient(90deg,#4facfe,#00f2fe); }
  .kid-andrew .score-badge { background: linear-gradient(135deg,#4facfe,#00f2fe); }
  .kid-andrew .chore-item.done .chore-check { background: linear-gradient(135deg,#4facfe,#00f2fe); }
  .jump-andrew { background: linear-gradient(135deg,#4facfe,#00f2fe); }

  .kid-felix .kid-header { background: linear-gradient(135deg,#43e97b22,#38f9d722); }
  .kid-felix .kid-avatar { background: linear-gradient(135deg,#43e97b,#38f9d7); }
  .kid-felix .progress-bar { background: linear-gradient(90deg,#43e97b,#38f9d7); }
  .kid-felix .score-badge { background: linear-gradient(135deg,#43e97b,#38f9d7); }
  .kid-felix .chore-item.done .chore-check { background: linear-gradient(135deg,#43e97b,#38f9d7); }
  .jump-felix { background: linear-gradient(135deg,#43e97b,#38f9d7); }

  .kid-lucy .kid-header { background: linear-gradient(135deg,#fa709a22,#fee14022); }
  .kid-lucy .kid-avatar { background: linear-gradient(135deg,#fa709a,#fee140); }
  .kid-lucy .progress-bar { background: linear-gradient(90deg,#fa709a,#fee140); }
  .kid-lucy .score-badge { background: linear-gradient(135deg,#fa709a,#fee140); }
  .kid-lucy .chore-item.done .chore-check { background: linear-gradient(135deg,#fa709a,#fee140); }
  .jump-lucy { background: linear-gradient(135deg,#fa709a,#fee140); }

  .kid-leo .kid-header { background: linear-gradient(135deg,#f7971e22,#ffd20022); }
  .kid-leo .kid-avatar { background: linear-gradient(135deg,#f7971e,#ffd200); }
  .kid-leo .progress-bar { background: linear-gradient(90deg,#f7971e,#ffd200); }
  .kid-leo .score-badge { background: linear-gradient(135deg,#f7971e,#ffd200); }
  .kid-leo .chore-item.done .chore-check { background: linear-gradient(135deg,#f7971e,#ffd200); }
  .jump-leo { background: linear-gradient(135deg,#f7971e,#ffd200); }
</style>
</head>
<body>

<header>
  <h1>â­ Hull Family Chores</h1>
  <p class="subtitle" id="headerSubtitle"></p>
</header>

<div class="top-bar">
  <div class="jump-links" id="jumpLinks"></div>
  <div class="right-bar">
    <div class="day-badge" id="dayBadge"></div>
    <div class="sync-indicator synced" id="syncIndicator">
      <div class="sync-dot" id="syncDot"></div>
      <span id="syncLabel">Live</span>
    </div>
  </div>
</div>

<div class="summary-bar" id="summaryBar"></div>
<div class="kids-grid" id="kidsGrid"></div>
<button class="reset-btn" onclick="resetAll()">ğŸ”„ Reset All Chores</button>

<!-- Avatar picker modal -->
<div class="modal-overlay" id="avatarModal">
  <div class="modal">
    <h3 id="modalTitle">Pick your avatar!</h3>
    <div class="emoji-grid" id="emojiGrid"></div>
    <button class="modal-close" onclick="closeAvatarModal()">Done âœ“</button>
  </div>
</div>

<!-- Confetti canvas -->
<canvas class="confetti-canvas" id="confettiCanvas"></canvas>

<!-- Celebration overlay -->
<div class="celebration" id="celebration">
  <div class="celebration-inner">
    <span class="celebration-emoji">ğŸ‰</span>
    <div class="celebration-text" id="celebText"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey: "AIzaSyBImvAIHP_3S9aDl0_yjhwtGG5pf1e5Z7k",
  authDomain: "hull-chores.firebaseapp.com",
  projectId: "hull-chores"
});
var db = firebase.firestore();

// =============================================
// KIDS & AVATARS
// =============================================
var KIDS = [
  { id:'theodore', name:'Theodore', age:11, defaultEmoji:'ğŸ¦' },
  { id:'alice',    name:'Alice',    age:9,  defaultEmoji:'ğŸ¦‹' },
  { id:'andrew',   name:'Andrew',   age:8,  defaultEmoji:'ğŸš€' },
  { id:'felix',    name:'Felix',    age:6,  defaultEmoji:'ğŸ¸' },
  { id:'lucy',     name:'Lucy',     age:5,  defaultEmoji:'ğŸŒ¸' },
  { id:'leo',      name:'Leo',      age:3,  defaultEmoji:'ğŸ»' },
];

var AVATAR_EMOJIS = [
  'ğŸ¦','ğŸ¦‹','ğŸš€','ğŸ¸','ğŸŒ¸','ğŸ»','ğŸ¶','ğŸ±','ğŸ¦Š','ğŸ¼','ğŸ¨','ğŸ¯',
  'ğŸ¦„','ğŸ²','ğŸ‘»','ğŸ¤–','ğŸ‘½','ğŸ¦¸','ğŸ§™','ğŸ¥·','ğŸ¤ ','ğŸ§Ÿ','ğŸ¦–','ğŸ¦•',
  'ğŸ™','ğŸ¦‘','ğŸ¦©','ğŸ¦š','ğŸ¦œ','ğŸŠ','ğŸ¦§','ğŸ¦£','ğŸ§¸','ğŸƒ','ğŸ•','ğŸŒ®',
  'ğŸ¦','ğŸ®','âš½','ğŸ†','ğŸ¸','ğŸš—','ğŸ›¸','ğŸ§¨','ğŸ¯','ğŸ§ƒ','ğŸ¦·','ğŸ’€',
  'ğŸ« ','ğŸ¤¡','ğŸ‘¾','ğŸ¥¸','ğŸ¤ª','ğŸ˜ˆ','ğŸ§ ','ğŸ«¶','ğŸ’¥','ğŸŒˆ',
];

// avatars stored in localStorage for instant load, also synced to Firestore
var avatars = {};

function loadAvatars() {
  try {
    var stored = localStorage.getItem('hull_avatars');
    if (stored) avatars = JSON.parse(stored);
  } catch(e) {}
}

function saveAvatarLocal() {
  try { localStorage.setItem('hull_avatars', JSON.stringify(avatars)); } catch(e) {}
}

function getEmoji(kidId) {
  return avatars[kidId] || KIDS.find(function(k){ return k.id === kidId; }).defaultEmoji;
}

// Persist avatars to Firestore too so they sync across devices
function saveAvatarsRemote() {
  db.collection('meta').doc('avatars').set(avatars).catch(function(){});
}

function loadAvatarsRemote() {
  db.collection('meta').doc('avatars').get().then(function(snap) {
    if (snap.exists) {
      var data = snap.data();
      for (var k in data) { avatars[k] = data[k]; }
      saveAvatarLocal();
      render();
    }
  }).catch(function(){});
}

// =============================================
// AVATAR PICKER
// =============================================
var pickingKidId = null;

function openAvatarModal(kidId) {
  pickingKidId = kidId;
  var kid = KIDS.find(function(k){ return k.id === kidId; });
  document.getElementById('modalTitle').textContent = kid.name + ', pick your avatar!';
  var grid = document.getElementById('emojiGrid');
  var current = getEmoji(kidId);
  grid.innerHTML = AVATAR_EMOJIS.map(function(e) {
    return '<div class="emoji-opt' + (e === current ? ' picked' : '') + '" onclick="pickEmoji(\'' + e + '\')">' + e + '</div>';
  }).join('');
  document.getElementById('avatarModal').classList.add('open');
  soundPop();
}

function pickEmoji(emoji) {
  if (!pickingKidId) return;
  avatars[pickingKidId] = emoji;
  saveAvatarLocal();
  saveAvatarsRemote();
  // Update picked highlight
  var opts = document.querySelectorAll('.emoji-opt');
  for (var i = 0; i < opts.length; i++) {
    opts[i].classList.toggle('picked', opts[i].textContent === emoji);
  }
  // Update avatar in card immediately
  var avatarEl = document.querySelector('#card-' + pickingKidId + ' .kid-avatar');
  if (avatarEl) avatarEl.childNodes[0] && (avatarEl.innerHTML = emoji + '<div class="avatar-edit-hint">âœï¸</div>');
  // Update jump link
  render();
  soundPop();
}

function closeAvatarModal() {
  document.getElementById('avatarModal').classList.remove('open');
  pickingKidId = null;
}

// Close modal on overlay click
document.getElementById('avatarModal').addEventListener('click', function(e) {
  if (e.target === this) closeAvatarModal();
});

// =============================================
// SOUNDS (Web Audio API)
// =============================================
var audioCtx = null;

function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

// High five slap sound
function soundHighFive() {
  try {
    var ctx = getAudioCtx();
    var bufSize = ctx.sampleRate * 0.15;
    var buf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
    var data = buf.getChannelData(0);
    for (var i = 0; i < bufSize; i++) {
      var t = i / ctx.sampleRate;
      var env = Math.exp(-t * 30);
      data[i] = (Math.random() * 2 - 1) * env * 0.8;
      // Add a little smack tone
      data[i] += Math.sin(2 * Math.PI * 200 * t) * Math.exp(-t * 40) * 0.3;
    }
    var src = ctx.createBufferSource();
    src.buffer = buf;
    var gain = ctx.createGain();
    gain.gain.setValueAtTime(1, ctx.currentTime);
    src.connect(gain); gain.connect(ctx.destination);
    src.start();
  } catch(e) {}
}

// Whoops - uncheck
function soundUncheck() {
  try {
    var ctx = getAudioCtx();
    var osc = ctx.createOscillator();
    var gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.frequency.setValueAtTime(400, ctx.currentTime);
    osc.frequency.linearRampToValueAtTime(180, ctx.currentTime + 0.25);
    gain.gain.setValueAtTime(0.3, ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.25);
    osc.start(ctx.currentTime);
    osc.stop(ctx.currentTime + 0.25);
  } catch(e) {}
}

// Section complete - air horn burst
function soundSectionComplete() {
  try {
    var ctx = getAudioCtx();
    var freqs = [466, 587, 698, 880];
    freqs.forEach(function(f, i) {
      var osc = ctx.createOscillator();
      var gain = ctx.createGain();
      osc.type = 'sawtooth';
      osc.frequency.value = f;
      gain.gain.setValueAtTime(0, ctx.currentTime + i * 0.08);
      gain.gain.linearRampToValueAtTime(0.18, ctx.currentTime + i * 0.08 + 0.05);
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + i * 0.08 + 0.25);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(ctx.currentTime + i * 0.08);
      osc.stop(ctx.currentTime + i * 0.08 + 0.3);
    });
  } catch(e) {}
}

// Card complete - fanfare
function soundCardComplete() {
  try {
    var ctx = getAudioCtx();
    var notes = [523, 659, 784, 1047];
    notes.forEach(function(f, i) {
      var osc = ctx.createOscillator();
      var gain = ctx.createGain();
      osc.type = 'triangle';
      osc.frequency.value = f;
      gain.gain.setValueAtTime(0.0, ctx.currentTime + i * 0.12);
      gain.gain.linearRampToValueAtTime(0.3, ctx.currentTime + i * 0.12 + 0.05);
      gain.gain.linearRampToValueAtTime(0.0, ctx.currentTime + i * 0.12 + 0.35);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(ctx.currentTime + i * 0.12);
      osc.stop(ctx.currentTime + i * 0.12 + 0.4);
    });
  } catch(e) {}
}

// ALL kids done - absolute chaos
function soundAllDone() {
  try {
    var ctx = getAudioCtx();
    // Siren sweep
    for (var i = 0; i < 3; i++) {
      (function(idx) {
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(600, ctx.currentTime + idx * 0.4);
        osc.frequency.linearRampToValueAtTime(1200, ctx.currentTime + idx * 0.4 + 0.2);
        osc.frequency.linearRampToValueAtTime(600, ctx.currentTime + idx * 0.4 + 0.4);
        gain.gain.setValueAtTime(0.25, ctx.currentTime + idx * 0.4);
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + idx * 0.4 + 0.4);
        osc.connect(gain); gain.connect(ctx.destination);
        osc.start(ctx.currentTime + idx * 0.4);
        osc.stop(ctx.currentTime + idx * 0.4 + 0.4);
      })(i);
    }
    // Ascending chime
    var chimeNotes = [523,659,784,880,1047,1319];
    chimeNotes.forEach(function(f, i) {
      var osc = ctx.createOscillator();
      var gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = f;
      gain.gain.setValueAtTime(0, ctx.currentTime + 1.2 + i * 0.1);
      gain.gain.linearRampToValueAtTime(0.35, ctx.currentTime + 1.2 + i * 0.1 + 0.05);
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 1.2 + i * 0.1 + 0.4);
      osc.connect(gain); gain.connect(ctx.destination);
      osc.start(ctx.currentTime + 1.2 + i * 0.1);
      osc.stop(ctx.currentTime + 1.2 + i * 0.1 + 0.5);
    });
  } catch(e) {}
}

// Generic pop for UI
function soundPop() {
  try {
    var ctx = getAudioCtx();
    var osc = ctx.createOscillator();
    var gain = ctx.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(800, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(400, ctx.currentTime + 0.1);
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.1);
    osc.connect(gain); gain.connect(ctx.destination);
    osc.start(); osc.stop(ctx.currentTime + 0.1);
  } catch(e) {}
}

// =============================================
// CONFETTI
// =============================================
var confettiPieces = [];
var confettiAnimating = false;

function launchConfetti(intensity) {
  var canvas = document.getElementById('confettiCanvas');
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
  var count = intensity === 'big' ? 200 : 80;
  confettiPieces = [];
  for (var i = 0; i < count; i++) {
    confettiPieces.push({
      x: Math.random() * canvas.width,
      y: -10 - Math.random() * 100,
      w: 8 + Math.random() * 8,
      h: 4 + Math.random() * 6,
      color: ['#667eea','#f093fb','#43e97b','#f7971e','#f5576c','#ffd200','#4facfe'][Math.floor(Math.random()*7)],
      vx: (Math.random() - 0.5) * 4,
      vy: 3 + Math.random() * 4,
      rot: Math.random() * 360,
      rotV: (Math.random() - 0.5) * 8,
    });
  }
  if (!confettiAnimating) animateConfetti();
}

function animateConfetti() {
  confettiAnimating = true;
  var canvas = document.getElementById('confettiCanvas');
  var ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  var alive = false;
  for (var i = 0; i < confettiPieces.length; i++) {
    var p = confettiPieces[i];
    p.x  += p.vx; p.y += p.vy; p.rot += p.rotV; p.vy += 0.1;
    if (p.y < canvas.height + 20) alive = true;
    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.rotate(p.rot * Math.PI / 180);
    ctx.fillStyle = p.color;
    ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
    ctx.restore();
  }
  if (alive) { requestAnimationFrame(animateConfetti); }
  else { confettiAnimating = false; ctx.clearRect(0,0,canvas.width,canvas.height); }
}

// =============================================
// CELEBRATION
// =============================================
function showCelebration(text, emoji, intensity) {
  var cel = document.getElementById('celebration');
  document.getElementById('celebText').textContent = text;
  cel.querySelector('.celebration-emoji').textContent = emoji;
  cel.style.background = intensity === 'big'
    ? 'radial-gradient(circle, rgba(102,126,234,0.85), rgba(118,75,162,0.85))'
    : 'radial-gradient(circle, rgba(67,233,123,0.7), rgba(56,249,215,0.7))';
  cel.classList.add('show');
  launchConfetti(intensity);
  setTimeout(function() { cel.classList.remove('show'); }, intensity === 'big' ? 3500 : 2000);
}

// =============================================
// DATA
// =============================================
var BIG_KIDS = ['theodore','alice','andrew','felix'];
var TOD_ORDER  = ['morning','afternoon','evening'];
var TOD_LABELS = { morning:'ğŸŒ… Morning', afternoon:'â˜€ï¸ Afternoon', evening:'ğŸŒ† Evening' };

var ROTATION_EPOCH = new Date('2025-03-01T00:00:00');
var MORNING_ROTATION = [
  { label:'Vacuum living room',            icon:'ğŸ§¹' },
  { label:'Vacuum front room',             icon:'ğŸ§¹' },
  { label:"Fill up Sophie's food & water", icon:'ğŸ¾' },
  { label:'Empty dishwasher',              icon:'ğŸ½ï¸' },
];
var EVENING_ROTATION = [
  { label:'Wipe kitchen counter', icon:'ğŸ§½' },
  { label:'Wipe kitchen table',   icon:'ğŸ§¹' },
  { label:'Tineco kitchen floor', icon:'ğŸ¤–' },
  { label:'Take out trash',       icon:'ğŸ—‘ï¸' },
];

function getRotationIndex(dateObj) {
  var msPerDay = 24 * 60 * 60 * 1000;
  var diff = Math.floor((dateObj - ROTATION_EPOCH) / msPerDay);
  return ((diff % 4) + 4) % 4;
}

function getRotatedChore(bigKidIndex, rotIdx, arr) {
  return arr[(rotIdx + bigKidIndex) % 4];
}

function buildSaturdayChores(kidId) {
  var chores = [];
  var everyoneMorning = ['Make bed','Brush teeth','Get dressed','Eat breakfast','Bring plates to sink'];
  var morningIcons    = ['ğŸ›ï¸','ğŸª¥','ğŸ‘•','ğŸ¥£','ğŸ«§'];
  for (var i = 0; i < everyoneMorning.length; i++) {
    chores.push({ tod:'morning', section:'Everyone', label:everyoneMorning[i], icon:morningIcons[i] });
  }
  if (kidId==='theodore') { chores.push({tod:'morning',section:'Family Chores',label:'Unload dishwasher',icon:'ğŸ½ï¸'}); chores.push({tod:'morning',section:'Family Chores',label:'Wipe bathroom sink',icon:'ğŸš¿'}); }
  if (kidId==='alice'||kidId==='lucy')   chores.push({tod:'morning',section:'Family Chores',label:'Wipe bathroom sink',icon:'ğŸš¿'});
  if (kidId==='andrew'||kidId==='felix') chores.push({tod:'morning',section:'Family Chores',label:'Wipe bathroom sink',icon:'ğŸš¿'});
  if (kidId==='leo')    chores.push({tod:'morning',section:'Family Chores',label:'Wipe bathroom sink',icon:'ğŸš¿'});
  if (kidId==='alice')  chores.push({tod:'morning',section:'Family Chores',label:'Vacuum living room',icon:'ğŸ§¹'});
  if (kidId==='andrew') chores.push({tod:'morning',section:'Family Chores',label:'Vacuum front room',icon:'ğŸ§¹'});
  if (kidId==='lucy'||kidId==='leo') chores.push({tod:'morning',section:'Family Chores',label:'Put away blankets',icon:'ğŸ›‹ï¸'});
  if (kidId==='felix')  chores.push({tod:'morning',section:'Family Chores',label:"Fill up Sophie's food & water",icon:'ğŸ¾'});
  chores.push({tod:'morning',section:'â¤ï¸ Special',label:'Go kiss Momma good morning!',icon:'ğŸ’‹'});
  // Afternoon
  chores.push({tod:'afternoon',section:'Everyone',label:'Eat lunch',icon:'ğŸ¥ª'});
  chores.push({tod:'afternoon',section:'Everyone',label:'Bring lunch plates to sink',icon:'ğŸ«§'});
  chores.push({tod:'afternoon',section:'Everyone',label:'Help fold laundry',icon:'ğŸ‘•'});
  chores.push({tod:'afternoon',section:'Everyone',label:'Put away lunch stuff',icon:'ğŸ§¹'});
  if (kidId==='andrew') { chores.push({tod:'afternoon',section:'Clean Up',label:'Load dishwasher',icon:'ğŸ«§'}); chores.push({tod:'afternoon',section:'Clean Up',label:'Take out recyclables',icon:'â™»ï¸'}); }
  if (kidId==='theodore') chores.push({tod:'afternoon',section:'Bathrooms',label:'Clean pool bathroom',icon:'ğŸš¿'});
  if (kidId==='alice')    chores.push({tod:'afternoon',section:'Bathrooms',label:'Clean front bathroom',icon:'ğŸš¿'});
  if (kidId==='felix')    chores.push({tod:'afternoon',section:'Bathrooms',label:'Clean basement bathroom',icon:'ğŸš¿'});
  // Evening
  chores.push({tod:'evening',section:'Everyone',label:'Eat dinner',icon:'ğŸ½ï¸'});
  chores.push({tod:'evening',section:'Everyone',label:'Bring dinner plates to sink',icon:'ğŸ«§'});
  chores.push({tod:'evening',section:'Everyone',label:'Eat dessert',icon:'ğŸ¨'});
  if (kidId==='theodore') chores.push({tod:'evening',section:'Clean Up',label:'Take out trash',icon:'ğŸ—‘ï¸'});
  if (kidId==='alice')    chores.push({tod:'evening',section:'Clean Up',label:'Wipe kitchen counter',icon:'ğŸ§½'});
  if (kidId==='andrew')   chores.push({tod:'evening',section:'Clean Up',label:'Take out recyclables',icon:'â™»ï¸'});
  if (kidId==='felix')    chores.push({tod:'evening',section:'Clean Up',label:'Load dishwasher',icon:'ğŸ½ï¸'});
  if (kidId==='lucy')     chores.push({tod:'evening',section:'Clean Up',label:'Wipe kitchen table',icon:'ğŸ§¹'});
  return chores;
}

function buildSundayChores(kidId, dateObj) {
  var chores = [];
  var bigIdx = BIG_KIDS.indexOf(kidId);
  var rotIdx = getRotationIndex(dateObj);
  var everyoneMorning = ['Make bed','Brush teeth','Get dressed for church','Eat breakfast','Bring plates to sink'];
  var morningIcons    = ['ğŸ›ï¸','ğŸª¥','â›ª','ğŸ¥£','ğŸ«§'];
  for (var i = 0; i < everyoneMorning.length; i++) {
    chores.push({ tod:'morning', section:'Everyone', label:everyoneMorning[i], icon:morningIcons[i] });
  }
  if (bigIdx !== -1) { var mc = getRotatedChore(bigIdx, rotIdx, MORNING_ROTATION); chores.push({tod:'morning',section:'Family Chores',label:mc.label,icon:mc.icon}); }
  if (kidId==='lucy'||kidId==='leo') chores.push({tod:'morning',section:'Family Chores',label:'Put away blankets',icon:'ğŸ›‹ï¸'});
  chores.push({tod:'morning',section:'â¤ï¸ Special',label:'Go kiss Momma good morning!',icon:'ğŸ’‹'});
  chores.push({tod:'afternoon',section:'Everyone',label:'Eat lunch',icon:'ğŸ¥ª'});
  chores.push({tod:'afternoon',section:'Everyone',label:'Bring lunch plates to sink',icon:'ğŸ«§'});
  chores.push({tod:'afternoon',section:'Everyone',label:'Put away lunch stuff',icon:'ğŸ§¹'});
  chores.push({tod:'evening',section:'Everyone',label:'Eat dinner',icon:'ğŸ½ï¸'});
  chores.push({tod:'evening',section:'Everyone',label:'Bring dinner plates to sink',icon:'ğŸ«§'});
  chores.push({tod:'evening',section:'Everyone',label:'Eat dessert',icon:'ğŸ¨'});
  if (bigIdx !== -1) { var ec = getRotatedChore(bigIdx, rotIdx, EVENING_ROTATION); chores.push({tod:'evening',section:'Clean Up',label:ec.label,icon:ec.icon}); }
  return chores;
}

function isSunday() { return new Date().getDay() === 0; }
function getDateString(d) { return d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate(); }
function getTodayKey() {
  var d = new Date();
  if (d.getDay() === 6) return 'saturday';
  return 'sunday_' + getDateString(d);
}
function getChoresToday(kidId) {
  return isSunday() ? buildSundayChores(kidId, new Date()) : buildSaturdayChores(kidId);
}

// =============================================
// FIREBASE
// =============================================
var choreState = {};
var unsub = null;
var TODAY_KEY = getTodayKey();

function docRef() { return db.collection('chores').doc(TODAY_KEY); }

function subscribe() {
  if (unsub) unsub();
  setSyncStatus('syncing');
  unsub = docRef().onSnapshot(function(snap) {
    choreState = snap.exists ? (snap.data().state || {}) : {};
    setSyncStatus('synced');
    render();
  }, function() { setSyncStatus('error'); });
}

function save() {
  setSyncStatus('syncing');
  docRef().set({ state: choreState, updatedAt: Date.now() })
    .then(function() { setSyncStatus('synced'); })
    .catch(function() { setSyncStatus('error'); });
}

function setSyncStatus(s) {
  document.getElementById('syncIndicator').className = 'sync-indicator ' + s;
  document.getElementById('syncDot').className = 'sync-dot' + (s === 'syncing' ? ' spinning' : '');
  document.getElementById('syncLabel').textContent = s==='syncing'?'Syncing...':s==='synced'?'Live':'Error';
}

// =============================================
// TOGGLE + SOUND LOGIC
// =============================================
function choreKey(kidId, tod, label) { return kidId+'__'+tod+'__'+label; }
function isChecked(kidId, tod, label) {
  var k = choreKey(kidId, tod, label);
  return !!(choreState[kidId] && choreState[kidId][k] && choreState[kidId][k].done);
}

// Track previous completion states for celebration triggers
var prevKidDone = {};
var prevAllDone = false;

function handleChore(kidId, tod, label, el) {
  el.classList.add('confetti-pop');
  setTimeout(function(){ el.classList.remove('confetti-pop'); }, 250);

  var k = choreKey(kidId, tod, label);
  if (!choreState[kidId]) choreState[kidId] = {};
  var was = choreState[kidId][k] && choreState[kidId][k].done;
  choreState[kidId][k] = { done: !was, ts: Date.now() };

  // Play sound
  if (!was) { soundHighFive(); }
  else       { soundUncheck(); }

  // Check section completion
  if (!was) {
    var chores = getChoresToday(kidId);
    var todChores = chores.filter(function(c){ return c.tod === tod; });
    var allTodDone = todChores.every(function(c){ return isChecked(kidId, c.tod, c.label) || c.label === label; });
    if (allTodDone && todChores.length > 0) {
      setTimeout(function(){ soundSectionComplete(); }, 150);
    }
  }

  render();
  save();
  checkCelebrations(kidId, was);
}

function checkCelebrations(justToggledKid, wasUncheck) {
  if (wasUncheck) return; // only celebrate on check, not uncheck

  var chores = getChoresToday(justToggledKid);
  var kidDone = chores.every(function(c){ return isChecked(justToggledKid, c.tod, c.label); });

  if (kidDone && !prevKidDone[justToggledKid]) {
    prevKidDone[justToggledKid] = true;
    var kid = KIDS.find(function(k){ return k.id === justToggledKid; });
    setTimeout(function(){
      soundCardComplete();
      showCelebration(kid.name + ' finished! ğŸ‰', getEmoji(justToggledKid), 'medium');
    }, 200);
  }

  // Check if all kids done
  var allDone = KIDS.every(function(k){
    var kc = getChoresToday(k.id);
    return kc.every(function(c){ return isChecked(k.id, c.tod, c.label); });
  });

  if (allDone && !prevAllDone) {
    prevAllDone = true;
    setTimeout(function(){
      soundAllDone();
      showCelebration('EVERYONE IS DONE! ğŸ†', 'ğŸ†', 'big');
    }, 500);
  }
}

// Reset celebration tracking when chores are reset
function resetCelebrationState() {
  prevKidDone = {};
  prevAllDone = false;
}

// =============================================
// RENDER
// =============================================
function render() {
  var sunday  = isSunday();
  var dayName = sunday ? 'Sunday' : 'Saturday';
  document.getElementById('headerSubtitle').textContent = (sunday?'â›ª':'ğŸ—“ï¸') + ' ' + dayName + ' Chores';
  var badge = document.getElementById('dayBadge');
  badge.textContent = dayName;
  badge.className = 'day-badge ' + (sunday ? 'sunday' : 'saturday');

  // Jump links
  document.getElementById('jumpLinks').innerHTML = KIDS.map(function(kid) {
    return '<a class="jump-link jump-' + kid.id + '" href="#card-' + kid.id + '">' +
      getEmoji(kid.id) + ' ' + kid.name.split(' ')[0] + '</a>';
  }).join('');

  // Summary
  var totalDone = 0, totalAll = 0;
  for (var ki = 0; ki < KIDS.length; ki++) {
    var kc = getChoresToday(KIDS[ki].id);
    totalAll += kc.length;
    for (var ci = 0; ci < kc.length; ci++) {
      if (isChecked(KIDS[ki].id, kc[ci].tod, kc[ci].label)) totalDone++;
    }
  }
  var pct = totalAll ? Math.round(totalDone/totalAll*100) : 0;
  document.getElementById('summaryBar').innerHTML =
    '<div class="summary-item">ğŸ“‹ ' + totalDone + ' / ' + totalAll + ' done</div>' +
    '<div class="summary-item">ğŸ† ' + pct + '%</div>';

  // Kid cards
  var gridHtml = '';
  for (var k = 0; k < KIDS.length; k++) {
    var kid    = KIDS[k];
    var chores = getChoresToday(kid.id);
    var doneCt = 0;
    for (var c = 0; c < chores.length; c++) {
      if (isChecked(kid.id, chores[c].tod, chores[c].label)) doneCt++;
    }
    var kpct    = chores.length ? Math.round(doneCt/chores.length*100) : 0;
    var allDone = chores.length > 0 && doneCt === chores.length;
    var emoji   = getEmoji(kid.id);

    var choreHtml = '<div class="chore-list">';
    for (var ti = 0; ti < TOD_ORDER.length; ti++) {
      var tod = TOD_ORDER[ti];
      var todChores = chores.filter(function(ch){ return ch.tod === tod; });
      if (todChores.length === 0) continue;

      choreHtml += '<div class="tod-divider tod-' + tod + '">' +
        '<span class="tod-divider-label">' + TOD_LABELS[tod] + '</span>' +
        '<div class="tod-divider-line"></div></div>';

      for (var ii = 0; ii < todChores.length; ii++) {
        var ch     = todChores[ii];
        var isDone = isChecked(kid.id, tod, ch.label);
        var ck     = choreKey(kid.id, tod, ch.label);
        var ts     = choreState[kid.id] && choreState[kid.id][ck] && choreState[kid.id][ck].ts;
        var tStr   = ts ? new Date(ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
        var safe   = ch.label.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
        choreHtml +=
          '<div class="chore-item' + (isDone?' done':'') + '"' +
          ' onclick="handleChore(\'' + kid.id + '\',\'' + tod + '\',\'' + safe + '\',this)">' +
          '<div class="chore-check">' + (isDone?'âœ“':'') + '</div>' +
          '<span class="chore-icon">' + ch.icon + '</span>' +
          '<div style="flex:1"><div class="chore-label">' + ch.label + '</div>' +
          (isDone&&tStr ? '<div class="chore-time">âœ“ '+tStr+'</div>' : '') +
          '</div></div>';
      }
    }
    choreHtml += '</div>';

    gridHtml +=
      '<div class="kid-card kid-' + kid.id + '" id="card-' + kid.id + '">' +
        '<div class="kid-header">' +
          '<div class="kid-avatar" onclick="openAvatarModal(\'' + kid.id + '\')">' +
            emoji + '<div class="avatar-edit-hint">âœï¸</div>' +
          '</div>' +
          '<div class="kid-info" style="flex:1">' +
            '<h2>' + kid.name + (allDone ? ' ğŸ‰' : '') + '</h2>' +
            '<div class="kid-age">Age ' + kid.age + ' Â· tap avatar to change</div>' +
            '<div class="progress-bar-wrap"><div class="progress-bar" style="width:' + kpct + '%"></div></div>' +
          '</div>' +
          '<div class="score-badge">' + doneCt + '/' + chores.length + '</div>' +
        '</div>' +
        choreHtml +
      '</div>';
  }
  document.getElementById('kidsGrid').innerHTML = gridHtml;
}

function resetAll() {
  if (!confirm('Reset all chores for today?')) return;
  choreState = {};
  resetCelebrationState();
  save();
  render();
}

// =============================================
// BOOT
// =============================================
loadAvatars();
loadAvatarsRemote();
subscribe();
</script>
</body>
</html>
